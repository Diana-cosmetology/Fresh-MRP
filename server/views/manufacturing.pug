extends layouts/main-layout

block append variables
  - pageID = 'manufacturing'

include mixins/table
include mixins/form-actions

block headTitle
    title MRP by deksden (#{pageID})

block bodyContent
  +erpTable('Manufacturing plan', manufacturing)
    thead.text-primary
      tr.col-md-8
        th.text-left Ready date
        th.text-left Process
        th.text-right Qnt
        th.text-center Actions
    tbody
      for mfg in manufacturing
        tr
          td.text-left #{ mfg.date }
          td.text-left
            a(href=`/erp/processes/${mfg.processId}`) #{mfg.processId}
          td.text-right #{ mfg.qnt }
          +formActions(`/erp/manufacturing/1.json`)
  // Modal
  #editModal.modal.fade(tabindex='-1' role='dialog' aria-labelledby='EditModal' aria-hidden='true')
    .modal-dialog(role='document')
      .modal-content
        form#editForm
            .modal-header
              h5#exampleModalLabel.modal-title Edit record:
              button.close(type='button' data-dismiss='modal' aria-label='Close')
                span(aria-hidden='true') &times;
            .modal-body
                i.now-ui-icons.loader_gear.spin
                span='  Loading ...'
            .modal-footer
              button.btn.btn-primary#btnSave(type='button') Save changes
              button.btn.btn-secondary(type='button' data-dismiss='modal') Close

block bodyJS
  script.
    const initDatetimePickerPlugin = function () {
      var dateInput = $(".datetimepicker");

      dateInput.parent().css("position", "relative");
      dateInput.datetimepicker({
        locale: 'ru',
        format: 'L',
        icons: {
          time: "fa fa-clock-o",
          date: "fa fa-calendar",
          up: "fa fa-chevron-up",
          down: "fa fa-chevron-down",
          previous: 'fa fa-chevron-left',
          next: 'fa fa-chevron-right',
          today: 'fa fa-screenshot',
          clear: 'fa fa-trash',
          close: 'fa fa-remove'
        }
      })
    }

    $('#btn-edit').click(function() {
      var url = $(this).data("url")
      $.ajax({
        url: url,
        dataType: 'json',
        success: function(data) {
          // set URL for save buttton:
          $('#btnSave').data('url', url)

          var formBody = $('.modal-body')
          formBody.html(
            '<row><col>'+

            '<div class=""form-group">'+
            '<label for="date">Date:</label>'+
            '<input id="date" name="date" placeholder="date" type="text" class="form-control datetimepicker" value="'+
              data.date+'"</input>'+
            '</div>'+//form-group

            '<div class=""form-group">' +
            '<label for="date">Qnt:</label>' +
            '<input id="qnt" name="qnt" placeholder="Qnt" type="number" class="form-control" value="' +
            data.qnt + '"</input>' +
            '</div>' +//form-group

            '<div class=""form-group">' +
            '<label for="date">Process ID:</label>' +
            '<input id="processId" name="processId" placeholder="processId" type="text" class="form-control" value="' +
            data.processId + '"</input>' +
            '</div>' +//form-group

            '</col></row>'
          )
          initDatetimePickerPlugin()
        },
        error: function(request, status, error) {

          $('.modal-body').html(
            '<h3>Error loading form data from server</h3>'+
            '<p> Request: '+request.toString()+'</p>'+
            '<p> Status: '+status.toString()+'</p>'+
            '<p> Error: '+error.toString()+'</p>'
          )
        }
      })
    })

    $('#btnSave').click(function() {
      var url=$(this).data("url")
      $(this).addClass('disabled').text('Saving changes ...')
      $.ajax({
        url: url,
        contentType: 'application/json',
        dataType: 'json',
        type: 'POST',
        data: JSON.stringify($("#editForm").serializeJSON()),
        success: function(data) {
          console.log('saved!')
          $(this).removeClass('disabled').text('Save changes')
          $('#editModal').modal('hide')
          location.reload()
        },
        error: function() {
          $(this).removeClass('disabled').text('Changes not saved!')
        }
      })
    })


